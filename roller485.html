<script type="text/javascript">
    RED.nodes.registerType('roller485', {
        category: 'M5Stack',
        color: '#ff9900',
        defaults: {
            name: {value: ""},
            busName: {value: "default"},
            usePins: {value: false},
            sda: {value: ""},
            scl: {value: ""},
            hz: {value: ""}
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-rotate-right",
        label: function() {
            return this.name || "Roller485";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            const tabs = RED.tabs.create({
                id: "node-roller485-tabs",
                onchange: function(tab) {
                    $("#node-roller485-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "roller485-tab-bus",
                label: "Bus"
            });
            tabs.addTab({
                id: "roller485-tab-pins",
                label: "Pins"
            });
            
            // Pinsタブの表示切り替え
            $("#node-input-usePins").on("change", function() {
                if ($(this).is(":checked")) {
                    $(".pins-config").show();
                } else {
                    $(".pins-config").hide();
                }
            });
            
            // 初期状態の設定
            if ($("#node-input-usePins").is(":checked")) {
                $(".pins-config").show();
            } else {
                $(".pins-config").hide();
            }
        }
    });
</script>

<script type="text/html" data-template-name="roller485">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-roller485-tabs"></ul>
    </div>
    
    <div id="node-roller485-tabs-content" style="min-height: 150px;">
        <div id="roller485-tab-bus" style="display:none">
            <div class="form-row">
                <label for="node-input-busName"><i class="fa fa-random"></i> Bus Name</label>
                <input type="text" id="node-input-busName" placeholder="default">
                <div class="form-tips">
                    <b>default</b> uses the default I2C bus for your device.
                </div>
            </div>
        </div>
        
        <div id="roller485-tab-pins" style="display:none">
            <div class="form-row">
                <label style="width: auto; margin-right: 10px;">
                    <input type="checkbox" id="node-input-usePins" style="width: auto; margin: 0;">
                    Use custom pins
                </label>
            </div>
            
            <div class="pins-config">
                <div class="form-row">
                    <label for="node-input-sda"><i class="fa fa-microchip"></i> SDA</label>
                    <input type="number" id="node-input-sda" placeholder="Pin number">
                </div>
                
                <div class="form-row">
                    <label for="node-input-scl"><i class="fa fa-microchip"></i> SCL</label>
                    <input type="number" id="node-input-scl" placeholder="Pin number">
                </div>
                
                <div class="form-row">
                    <label for="node-input-hz"><i class="fa fa-tachometer"></i> Speed</label>
                    <input type="number" id="node-input-hz" placeholder="Hz (default: 100000)">
                    <span style="margin-left: 5px;">Hz</span>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="roller485">
    <p>M5Stack Roller485 UnitをNode-RED MCU Editionで制御するノードです。</p>
    
    <h3>入力</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">number</span>
        </dt>
        <dd>回転させる角度(degree)を指定します。-360〜360の範囲で指定してください。</dd>
    </dl>

    <h3>出力</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>
            <ul>
                <li><code>angle</code> - 設定した角度</li>
                <li><code>status</code> - "ok" または "error"</li>
            </ul>
        </dd>
    </dl>

    <h3>設定</h3>
    
    <h4>Busタブ</h4>
    <dl class="message-properties">
        <dt>Bus Name <span class="property-type">string</span></dt>
        <dd>I2Cバス名を指定します。デフォルトは "default" でデバイスのデフォルトI2Cバスを使用します。</dd>
    </dl>
    
    <h4>Pinsタブ</h4>
    <dl class="message-properties">
        <dt>Use custom pins <span class="property-type">boolean</span></dt>
        <dd>チェックするとカスタムピン設定を有効にします。</dd>
        
        <dt>SDA <span class="property-type">number</span></dt>
        <dd>I2CのSDAピン番号を指定します(カスタムピン使用時)。</dd>
        
        <dt>SCL <span class="property-type">number</span></dt>
        <dd>I2CのSCLピン番号を指定します(カスタムピン使用時)。</dd>
        
        <dt>Speed <span class="property-type">number</span></dt>
        <dd>I2C通信速度をHzで指定します。デフォルトは100000(100kHz)です。</dd>
    </dl>

    <h3>詳細</h3>
    <p>このノードは、M5Stack Roller485 UnitをI2C経由で制御します。</p>
    <p><code>msg.payload</code>に角度(degree)を数値で渡すと、その角度まで回転します。</p>
    <p>角度は-360度から360度の範囲で指定できます。</p>
    
    <h3>参考</h3>
    <ul>
        <li><a href="https://docs.m5stack.com/ja/unit/Unit-Roller485">Roller485 Unit</a></li>
    </ul>
</script>
